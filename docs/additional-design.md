# 短歌茶屋 追加機能設計書（大喜利茶屋仕様差分対応）

## 0. 背景と目的
- 参照資料: 「大喜利茶屋の徹底分析と短歌版サービス開発のためのAI指示書」(2025-??, PDF)
- 現状リポジトリ `tanka-chaya` はリアルタイム短歌イベントのMVPを実装済みだが、参照資料が求める機能群（イベント多様化、決勝やシーズン制、モデレーション等）は未着手。
- 本書は **既存実装との差分を埋めるための追加スコープ** を整理し、段階的に開発できる設計指針を提示する。

## 1. 差分サマリ
1. **イベントの自動スケジュールとモード多様化**: 現状は手動作成／テストイベントのみ。資料では夜・昼・季節・日めくり・練習部屋などの定期／常設運用が前提。
2. **決勝ラウンドと部屋再編**: 80名超での部屋分割、上位20%による決勝戦、決勝時の得点補正ロジックが未実装。
3. **投票義務化とペナルティ／ボーナス**: 持ち票強制消化、未投票ペナルティ、投票完了時の自作品加点(+2)が存在しない。
4. **ポイント計算・シーズン制・メダル管理**: DBにメダル／シーズンの枠はあるが運用ロジック・画面・ランキングが未整備。標準偏差を用いたスコアリング要求も未反映。
5. **モデレーションと不正対策**: NGワード、AI生成検知、多重投票監視、違反報告／BANフロー、ご意見箱などが未実装。
6. **ユーザー体験面の拡張**: プロフィール詳細、過去投稿閲覧、OGP生成とSNS共有、日めくりでのお題選択、練習用ルーム、特別企画テンプレート化などが不足。

## 2. 機能要件拡張

### 2.1 イベントスケジュールとモード
- **夜の歌会**: 毎日22:00開始。6ラウンド、各ラウンド4分投稿→投票→結果。開催頻度は `RecurringEventTemplate` による自動生成。
- **昼の歌会**: 土日14:00開始。同じく6ラウンド。
- **季節の歌会**: 平日14:00を基本、季節毎にテーマをプリセット。開催期間をテンプレートで管理。
- **日めくり短歌会**: 毎日11:00にお題更新。24h投稿→24h投票→翌朝結果。複数お題から任意選択可能。
- **練習部屋／特殊企画**: 常設部屋またはオンデマンドで作成。スコア反映の有無を設定可能。
- **実装方針**:
  - `RecurringEventTemplate` テーブルを追加し、開始時刻・頻度・参加定員・投稿／投票／結果時間を定義。
  - `EventAutoScheduler` サービスを追加し、テンプレートに基づき `Event` を事前生成。開始10分前にテーマを割当、開始時に `scheduledEventManager` へ移譲。
  - 日めくり専用の `DailyEventController` を追加し、複数テーマ提示とユーザー選択を記録。

### 2.2 部屋分割と決勝戦
- 参加登録時、イベント単位で `Room` を80人上限で割り振る（既存実装は新規ルーム生成のみ）。併せて `room_participant` をイベント内で一意にする。
- 5ラウンド終了時、各部屋の得票上位20%を `EventFinalist` として抽出。決勝専用ルーム（1室）へ再配置し、6ラウンド目を実行。
- 決勝の投票では、決勝進出者以外も投票可能。投票者数に応じて重み係数 `w = 1 + (voterCount / finalistCount) * α` を導入し、得票に乗算。
- 結果発表では予選と決勝のスコアを統合し、順位・得票・補正後ポイントを表示。

### 2.3 投票ロジックとポイント
- 持ち票は `max(1, round(participantCount * 0.1))` で算出（現行UIは対応済）。投票完了フラグを `VoteSession` に記録。
- 投票締切時点で `VoteSession.completed=false` のユーザーには `Penalty` を付与し、該当ラウンドの自作品から所定ポイント(例: -5)を減算。連続未投票で自動警告→アカウント停止キューへ。
- 投票完了者には自作品へ+2点のボーナスを加算。
- スコア計算は `points = ΣweightedVotes` としつつ、回ごとの平均・標準偏差を算出して `normalizedScore = (points - μ)/σ` をレポート用に保持。
- メダル付与: 各イベント終了時に1〜3位へ金・銀・銅、上位10%へ入賞メダルを配布し、`User.totalPoints` をテンプレ換算式で更新。
- シーズン制: `Season` テーブルで進行中シーズンを維持。夜の歌会100回終了時に `isActive=false` とし、新シーズンを生成。ランキング画面ではシーズン別＋累計を表示。

### 2.4 モデレーションと不正対策
- NGワード／ハラスメント辞書を `ModerationRule` として管理。投稿時に同期検査、AI推定が必要な場合は非同期で `ModerationQueue` へ投入。
- AI判定サービス（外部API想定）と協業し、`autoFlagged` フラグを `Submission`／`Theme` に保持。疑義があれば管理者承認まで公開停止。
- 多重投票／複数アカウント: `VoteAuditLog` にIP・UserAgent・投票時間帯を記録。ヒューリスティック検出→`ModerationIncident` に記録し、管理者へ通知。
- ご意見箱／違反報告: `Feedback` エンドポイントを新設し、ユーザーが匿名／署名付きで投稿可能。管理画面から対応状況を更新。
- 管理者機能: ユーザーBAN／ペナルティ付与、フラグ済み投稿・お題の承認、不正ログ閲覧を実装。

### 2.5 ユーザー体験拡張
- プロフィール画面: 過去投稿、獲得メダル、シーズン別ポイント、達成実績を可視化。公開・非公開設定を提供。
- 日めくりUI: 複数お題カードから選択、残り投稿／投票時間のカウントダウンを表示。
- 練習部屋: スコアに影響しない自由投稿専用ルーム。即時フィードバックやブックマーク機能を提供。
- OGP画像生成: 投稿確定時にCloud Function等で静的画像を生成し、SNS共有URLに添付。
- オンボーディングとリマインダー: プッシュ通知／メールでイベント開始前、未投票ユーザーへのリマインドを送信（後続対応可能）。

## 3. 非機能・運用要件
- **リアルタイム耐性**: 1イベントで同時300接続を想定。Socket.IOネームスペースを `event:<id>` / `room:<id>` に分割し、Redis Adapter導入を検討。
- **スケーラビリティ**: イベントテンプレート追加のみで新企画を投入できるよう設定駆動化。コンフィグはJSON/YAMLでPR管理。
- **セキュリティ**: 全APIをHTTPS想定。JWTのローテーション、コンテンツサニタイズ、Rate Limit（特に投票API）。
- **観測性**: 重要指標(参加者数、投票完了率、フラグ件数)をダッシュボード化。Slack/Webhook通知を用意。

## 4. アーキテクチャ変更

### 4.1 データベース変更案
- `RecurringEventTemplate`: `id`, `type`, `title`, `cronExpression`, `roundCount`, `submissionDurationSec`, `votingDurationSec`, `finalEnabled`, `maxParticipants`, `active`。
- `EventFinalist`: `id`, `eventId`, `userId`, `roomId`, `qualifyingScore`, `seedRank`。
- `VoteSession`: `id`, `eventId`, `round`, `userId`, `completed`, `penaltyApplied`, `bonusApplied`, `updatedAt`。
- `PenaltyLog`: `id`, `userId`, `eventId`, `round`, `reason`, `pointsDelta`。
- `ModerationRule`, `ModerationQueue`, `ModerationIncident`, `Feedback` テーブル追加。
- `Theme` 拡張: `description`, `imageUrl`, `sourceType(user|admin)`, `status(pending|approved|rejected)`。
- `Submission` 拡張: `finalRound`, `normalizedScore`, `moderationStatus`, `flagReason`。
- `User` 拡張: `bio`, `avatarUrl`, `streakCount`, `banUntil`。

### 4.2 サービス層
- `EventAutoScheduler`: テンプレート→イベント生成、スケジュール監視を担うバックグラウンドジョブ。
- `FinalRoundService`: ランク集計、決勝進出判定、投票補正を実装。
- `ScoringService`: 標準偏差算出、ボーナス／ペナルティ適用、メダル配布、シーズン更新を担当。
- `ModerationService`: NGワードチェック、AI判定連携、インシデント通知。
- `FeedbackService`: ご意見箱・違反報告の管理とエスカレーション。
- `PracticeRoomService`: 常設ルーム状態と参加管理。

### 4.3 API変更
- `GET /api/schedule/upcoming` : 直近イベント・テンプレート情報。
- `POST /api/events/:id/finalize-round` : ラウンド終了処理（内部用Webhookでも可）。
- `POST /api/votes/session` : 投票開始／完了ステータスを更新。
- `POST /api/penalties/apply` : 自動／手動ペナルティ付与。
- `GET/POST /api/themes/proposals` : ユーザーお題投稿と承認フロー。
- `POST /api/moderation/flag` : 連絡／自動フラグ記録。
- `POST /api/feedback` : ご意見箱投稿。
- `GET /api/profile/:userId` : プロフィール詳細取得（公開用）。

### 4.4 フロントエンド改修
- 新規ページ: `Schedule`, `Profile`, `Seasons`, `PracticeRoom`, `Feedback`。
- イベントルーム: 決勝モードUI、残り投票時間、未投票アラート、ペナルティ警告を追加。
- 日めくりUI: お題選択ステップとタイムライン表示、投稿履歴導線。
- 管理画面: フラグ一覧、ユーザーBAN／解除、テンプレートCRUD、フィードバック対応状況更新。
- SNS共有: 投稿詳細モーダルから共有可能なOGPプレビューを提供。

## 5. 移行と段階的リリース案
1. **Phase 1**: テンプレート＋自動スケジュール、決勝ラウンド、投票セッション記録。
2. **Phase 2**: スコアリング再設計（ボーナス・メダル・シーズン）、ランキング／プロフィールUI。
3. **Phase 3**: モデレーション強化、フィードバック、練習部屋、OGP共有。
4. **Phase 4**: 日めくり高度化（複数お題・24hフロー）、多言語対応、通知基盤。
5. 各フェーズ毎に Prisma migration とデータシード（テンプレート／ルール）を実施し、既存イベントへの影響を最小化する。

## 6. リスクと未決事項
- 決勝戦の得点補正係数αの最適値は未確定。βテストで調整が必要。
- 投票義務化に伴うユーザー離脱リスク。UI上のリマインドと救済（例: システム障害時の免除）を整備する。
- AIモデレーションは外部サービス依存。コスト／精度／レイテンシを評価し、フォールバックルールを用意。
- OGP生成には画像合成基盤が必要。短期的にはサーバーサイドでHTML→PNGを生成、長期的には専用ワーカーを検討。
- 練習部屋や特殊企画のポイント扱い（影響する／しない）をどうするか運営ポリシーの確認が必要。

---

本設計書は、既存MVPを土台に大喜利茶屋由来の要求を満たすための追加スコープを整理したものである。各フェーズ実装時には、本書をベースに詳細設計（ER図、シーケンス図、画面モック）を追補すること。
