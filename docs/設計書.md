# 大喜利茶屋 設計書（たたき台）

- 作成日: 2025-10-07
- 対象リポジトリ: `tanka-chaya`
- 目的: 提示される「仕様書」と現状実装を突き合わせ、ギャップを可視化し、設計の基盤を用意する。
- 注意: 本書は仕様書未受領のため仮置きの要素を含みます。仕様確定後に確定版へ更新します。

---

## 1. 現状リポジトリ概要（確認済の範囲）

- ルート直下の構成（一覧取得で確認）
  - ディレクトリ: `client/`, `server/`, `node_modules/`
  - ファイル: `.gitignore`, `package.json`, `package-lock.json`, `README.md`
- 推測される技術要素（要確認）
  - Node.js + npm（`package-lock.json` あり）
  - クライアント・サーバの二層構成（`client/` と `server/`）

> 備考: 現時点ではファイル内容の読み取りが未実施/未確認。`package.json` の `scripts` と依存関係、`client/`・`server/` のフレームワーク特定は次回更新で反映。

---

## 2. 要求仕様トレース表（ギャップ分析用テンプレ）

仕様書を受領後、以下の表を埋めてカバレッジとギャップを明確化します。

| 要件ID | 要件（仕様書抜粋） | 優先度 | 実装状況 | 根拠（画面/API/コード） | 備考 |
|---|---|---|---|---|---|
| R-001 | 例: お題作成・配布ができる | High | 未判定 | 例: `server` のAPI, `client`の画面 | 要確認 |
| R-002 | 例: 作品投稿（テキスト/画像） | High | 未判定 |  |  |
| R-003 | 例: 投票と集計 | High | 未判定 |  |  |
| R-004 | 例: ランキング表示 | Mid | 未判定 |  |  |
| ... |  |  |  |  |  |

- 実装状況の定義
  - 実装済: 動作まで確認済み
  - 部分: 最低限のAPI/画面はあるが未完成
  - 未実装: 該当実装なし
  - 未判定: 読み取り/動作確認が未了

---

## 3. 想定ドメインモデル（ドラフト）

仕様確定前の叩き台です。実装/仕様に合わせて更新。

- User: `id`, `name`, `avatar`, `role`（host/player/moderator）
- Room: `id`, `code`, `status`（lobby/playing/finished）, `hostId`
- Round: `id`, `roomId`, `promptId`, `phase`（submit/vote/result）, `startAt`, `endAt`
- Prompt: `id`, `text`, `createdBy`
- Entry: `id`, `roundId`, `userId`, `content`（text/url）, `createdAt`
- Vote: `id`, `roundId`, `entryId`, `voterId`, `weight`

---

## 4. API設計（ドラフト／候補）

実装調査後に確定。パスや認可は仕様書に合わせて調整。

- Auth
  - POST `/api/auth/guest` ゲスト参加
  - POST `/api/auth/login` / POST `/api/auth/logout`
- Rooms
  - POST `/api/rooms` ルーム作成（ホスト）
  - POST `/api/rooms/{code}/join` 参加
  - GET `/api/rooms/{code}` ルーム状態取得
- Rounds / Prompts
  - POST `/api/rooms/{code}/rounds` ラウンド開始（お題指定）
  - GET `/api/rooms/{code}/rounds/current` 現在ラウンド取得
- Entries
  - POST `/api/rounds/{id}/entries` 作品投稿
  - GET `/api/rounds/{id}/entries` 作品一覧
- Votes
  - POST `/api/rounds/{id}/votes` 投票
  - GET `/api/rounds/{id}/results` 集計結果

- リアルタイム（候補）
  - WebSocket/Socket.IO チャンネル: `room:{code}`
  - イベント: `round:started`, `entry:created`, `vote:cast`, `result:published`, `room:state`

---

## 5. 画面/ユーザーフロー（ドラフト）

- トップ → ルームコード入力/作成 → ロビー →（ラウンド開始）→ 作品投稿 → 投票 → 結果表示 → 次ラウンド
- 主要画面（候補）: ロビー, 投稿, 投票, 結果, 管理（ホスト）

---

## 6. 非機能要件（確認観点）

- 同時接続数/スケール、遅延要件（投票/結果反映のリアルタイム性）
- 認証/認可（ゲスト, SNS, 管理者）とモデレーション（通報/NGワード）
- 永続化（RDB/NoSQL）、セッション管理、スナップショット
- ロギング/監視、エラーハンドリング、リトライ
- 多言語・アクセシビリティ、モバイル最適化

---

## 7. ギャップ一覧（仕様書と現状実装の差分）

> 仕様書受領後に更新。以下は記入ルールのみ。

- 必須だが実装が見当たらない機能（要件IDを添える）
- 実装はあるが仕様と乖離している点
- 仕様にあるが非機能/運用が未整備の点
- 依存技術の選定未決事項

---

## 8. 次アクション

1. 仕様書を受領し、§2のトレース表を初版作成（優先度/スプリント割当）
2. `package.json` と `client/`・`server/` のフレームワーク特定
3. API/DB/イベントのインターフェースを実装に合わせて確定
4. 動作確認手順とテスト方針（E2E/負荷）を追記

---

### 付録A. ギャップ分析の入力フォーマット（例）

```yaml
- id: R-001
  title: お題作成
  priority: high
  spec: ホストはお題を作成して配布できる
  implementation: 未判定（server側API未確認）
  notes: 要API/画面確認
```

